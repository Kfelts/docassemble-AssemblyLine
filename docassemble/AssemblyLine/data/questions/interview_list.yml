---
# Provide a replacement for the /interviews endpoint in Docassemble
---
include: 
  - docassemble.ALToolbox:display_template.yml
  - al_settings.yml
---
features:
  small screen navigation: dropdown
  navigation: True
  navigation back button: False
  javascript:
    - al_audio.js
  css:
    - styles.css
    - al_audio.css
  question help button: True
  question back button: False
---
metadata:
  title: |
    In progress forms
  short title: |
    In progress forms
  unique session: True    
---
modules:
  - .sessions
  - docassemble.ALToolbox.misc
---
objects:
  - al_logo: DAStaticFile.using(filename="ma_logo.png", alt_text="Assembly Line Logo")
---
code: |
  al_logo.alt_text = "Assembly Line Logo"
---
default screen parts:
  title: |
    ${ all_variables(special='metadata').get('title', AL_ORGANIZATION_TITLE) }
  short title: |
    ${ all_variables(special='metadata').get('short title', AL_ORGANIZATION_TITLE) }
  title url: |
    ${ all_variables(special='metadata').get('title url', AL_ORGANIZATION_HOMEPAGE) }
  exit url: |
    ${ all_variables(special='metadata').get('exit url', AL_ORGANIZATION_HOMEPAGE) }
  logo: |
    <span class="title-container">
      <span class="al-logo">
        <img src="${ al_logo.url_for() }" alt="${ al_logo.alt_text }"/>
      </span>
      <span class="al-title">
        <span class="title-row-1">${ AL_ORGANIZATION_TITLE }</span>
        <span class="title-row-2">${all_variables(special='metadata').get('title','').rstrip()}</span>
      </span>
    </span>
  short logo: |
    <span class="title-container">
      <span class="al-logo">
        <img src="${ al_logo.url_for() }" alt="${ al_logo.alt_text }"/>
      </span>
      <span class="al-title">
        <span class="title-row-1">${ AL_ORGANIZATION_TITLE }</span>
        <span class="title-row-2">${ all_variables(special='metadata').get('short title','').rstrip() }</span>
      </span>
    </span>
---
sections:
  - section_in_progress_forms: In progress forms
  - section_answer_sets: Answer sets
progressive: False
---
mandatory: True
event: section_in_progress_forms
id: interview list
question: |
  In progress forms <span style="float: right;">${ action_button_html(get_config("assembly line",{}).get("new form url", AL_ORGANIZATION_HOMEPAGE), label="Start a new form", icon="plus-circle", color="primary", size="md") }</span>
subquestion: |
  Tap the title of a form to keep working on it or to download your completed
  documents.

  ${ session_list_html(filename=None, limit=20, offset=session_page) }
  
  % if session_page > 0:
  [< Previous page](${ url_action("update_page_event", page_increment=-1) })
  % endif  
  [Next page >](${ url_action("update_page_event", page_increment=1) })
section: section_in_progress_forms
---
event: section_answer_sets
id: answer set list
question: |
  Answer sets <span style="float: right;">${ action_button_html(get_config("assembly line",{}).get("new form url", AL_ORGANIZATION_HOMEPAGE), label="Start a new form", icon="plus-circle", color="primary", size="md") }</span>
subquestion: |
  View, delete, or rename your answer sets below. To copy an answer set into a
  new form:
  
  1. [Start a new 
  form](${ get_config("assembly line",{}).get("new form url", AL_ORGANIZATION_HOMEPAGE) })
  1. Then, use the menu to load your answer set.

  ${ interview_list_html(view_only=True, delete_action="interview_list_delete_session") }
section: section_answer_sets
---
code: |
  session_page = 0
---
event: update_page_event
code: |
  session_page += action_argument("page_increment")
---
code: |
  # Get the existing form's subtitle
  session_vars = get_session_variables(filename, session_id)
  existing_subtitle = session_vars.get("_internal",{}).get("subtitle", session_vars.get("_internal",{}).get("title", "Untitled interview"))
---
id: copy to answer set
question: |
  Copy as answer set
subquestion: |
  Before saving your answer set, give the answers a name.

  Pick a name that will help you choose the right answers to use on a new form.
fields:
  - Name: al_sessions_copy_as_answer_set_label
    default: ${ existing_subtitle }
continue button label: |
  :save: Save copy
---
code: |
  save_interview_answers(
      source_filename=existing_filename,
      source_session=existing_session_id,
      metadata={
        "title": al_sessions_copy_as_answer_set_label
        }
      )
  copy_as_answer_set = True
---
id: rename answer
question: |
  Rename saved answers
fields:
  - New name: al_sessions_snapshot_new_label
continue button label: |
  :save: Save changes
---
code: |
  rename_interview_answers(user_info().filename, user_info().session, new_name = al_sessions_snapshot_new_label)
  log("New name saved", "success")
  al_sessions_rename_session = True
